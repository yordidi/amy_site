var join = require('path').join;
var fs = require('fs');
var send = require('./send');
var normalize = require('./settings').normalize;
var url = require("url");

module.exports = directory;
function directory(path, options) {
  options = normalize(options);
  return function (req, res, next) {
    var qurl = req.url;
    var url_obj = url.parse(qurl);
    var path_name = url_obj.pathname;
    if (options.grep.test(path_name)) {
        
      var path = options.path || __dirname;
      fs.stat(join(path, path_name), function (err, stat) {
        if (err || !stat.isFile()) return next();
        send(join(path, path_name), options, req, res, next);
      });
    } else {
      return next();
    }
  };
}
